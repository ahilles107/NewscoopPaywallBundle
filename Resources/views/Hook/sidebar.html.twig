<style type="text/css" media="screen">
    .hook-content {font-size: 12px;}
    .hook-content .save-button {display: block;float: right;}
    .hook-content h4{margin-bottom: 0px; padding: 5px 0;margin-top: 15px;}
    .form-group label {font-weight: bold;}
    .hook-content .hook-currency { line-height: 25px; padding-left: 5px;}
    .js-paywall-status {padding: 5px 0;}
    .js-paywall-status-yes {color: #468847;}
    .js-paywall-status-no {color: #b94a48;}
    .hook-content #paywallpluginForm .input_text {width: 50%;}
</style>
{% form_theme form 'NewscoopPaywallBundle::forms.html.twig' %}
<div class="articlebox paywallplugin" title="Paywall - {{ 'paywall.label.paid'|trans}}">
    <div class="hook-content">
        <div id="alert-container" style="display: none; padding: 15px;" class="alert-{% if success %}success{% else %}danger{% endif %}" role="alert">
            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
            {% if success %}
            <span class="sr-only">Success:</span>
            {{ 'paywall.success.subsaved'|trans }}
            {% else %}
            <span class="sr-only">Error:</span>
            {{ 'paywall.error.suberror'|trans }}
            {% endif %}
            <br>
        </div>
        <div class="js-paywall-status"><strong>{{ 'paywall.label.paid'|trans }}: </strong>
            {% if subscription %}
            <span class="js-paywall-status-yes">{{ 'paywall.label.yes'|trans }}</span>
            {% else %}
            <span class="js-paywall-status-no">{{ 'paywall.label.no'|trans }}</span>
            {% endif %}
        </div>
        <br>
        <span class="js-paywall-status-no">(*)</span> - {{ 'paywall.label.requiredfields'|trans }}
        <form id="paywallpluginForm" action="{{ path('newscoop_paywall_hook_price', {articleNumber: articleNumber, articleLanguage: articleLanguage}) }}" method="POST" novalidate>
            <h4>{{ 'paywall.label.unitprice'|trans }} <span class="js-paywall-status-no">(*)</span></h4>
            {{ form_widget(subscriptionForm.price, {'attr' : {'class' : 'input_text'}}) }} <span class="hook-currency">{{ currency}}</span>
            <button type="submit" class="save-button paywall-button" style="margin-left: 5px;">{{'paywall.btn.save'|trans}}</button>
            {% if subscription %}
            <button type="submit" class="ui-state-default icon-button right-floated delete-subscription" style="margin-top: 3px; padding-left: 10px;">{{'paywall.btn.delete'|trans}}</button>
            {% endif %}
        </form>
        {% if subscription %}
        <hr>
        <form id="paywallpluginForm" action="{{ path('newscoop_paywall_hook_sidebar', {articleNumber: articleNumber, articleLanguage: articleLanguage}) }}" method="POST" novalidate>
            <h4>{{ 'paywall.label.period'|trans }} <span class="js-paywall-status-no">(*)</span></h4>
            {{ form_widget(form.value, {'attr' : {'class' : 'input_text'}}) }}
            {{ form_widget(form.attribute, {'attr' : {'class' : 'input_select'}}) }}
            <h4>{{ 'paywall.label.discount'|trans }}</h4>
            {{ form_widget(form.discount, {'attr' : {'class' : 'input_select'}}) }}
            <button type="submit" class="save-button paywall-button">{{'paywall.btn.add'|trans}}</button>
            {{ form_widget(form._token) }}
        </form>
        {% endif %}
        {% if subscription and subscription.ranges|length > 0 %}
        <hr>
        <table id="durationTable" style="width:100%" class="table">
            <thead>
                <tr>
                    <th>{{ 'paywall.step2.label.durationbox'|trans }}</th>
                    <th>{{ 'paywall.label.discount'|trans }}</th>
                    <th>{{ 'paywall.manage.label.options'|trans }}</th>
                </tr>
            </thead>
            <tbody>
                {% for range in subscription.ranges %}
                <tr id="{{ range.id }}">
                    <td><center>{{ range.value }}{% if range.attribute == 'month' %} {{ 'paywall.label.months'|trans }} {% endif %}</center></td>
                    <td><center>{% if range.discount %} {{ range.discount.name}} ({{ range.discount.value * 100 }}%){% else %} - {% endif %}</center></td>
                    <td><center><button title="{{ 'paywall.btn.delete'|trans }}" type="button" id="remove-duration" data-path="{{ path('newscoop_paywall_admin_duration_remove', {'id': range.id }) }}" class="btn btn-xs btn-danger">
                        <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                    </button></center></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
</div>
<script>
    $('.paywall-button').one('click', function(e){
        e.preventDefault();
        $(this).prop('disabled', true);
        var form = $(this).parent();
        var data = form.serialize();
        $.ajax({
            type: form.attr('method'),
            url: form.attr('action'),
            data: data,
            dataType: "html",
            success: function(msg){
                $(this).prop('disabled', false);
                $('.paywallplugin .hook-content').html(msg);
                $('#alert-container').show();
                setTimeout(function() {
                    $('#alert-container').fadeOut('fast');
                }, 3000);
            }
        });
    });

    var ranges = 0;
        rangesTemp = 0;
    {% if subscription %}
        ranges = {{ subscription.ranges|length }}
    {% endif %}

    rangesTemp = ranges;
    $('#remove-duration').die('click').live('click', function () {
        var that = $(this);
        {% if subscription %}
        ranges = {{ subscription.ranges|length }}
        {% endif %}
        callServer('ping', [], function(json) {
            $.ajax({
                type: 'POST',
                url: that.data('path'),
                success: function (data) {
                    if (data.status) {
                        rangesTemp = rangesTemp - 1;
                        if (rangesTemp <= 0) {
                            $('#durationTable').remove();
                            $('.paywallplugin .hook-content hr:last-child').remove();
                        } else {
                            that.parent().parent().parent().remove();
                        }
                        flashMessage('{{ 'paywall.success.removed'|trans }}');
                    } else {
                        flashMessage('{{ 'paywall.error.perioderror'|trans }}', "error");
                    }
                },
                error: function (rq, status, error) {
                    if (status == 0 || status == -1) {
                        flashMessage('Error occured!', "error");
                    }
                }
            });
        });

        return false;
    });
    {% if subscription %}
    $('#paywallpluginForm').on('click', '.delete-subscription', function(event){
        event.preventDefault();
        $.post('{{ path('newscoop_paywall_managesubscriptions_delete', {'id': subscription.id}) }}',
         function(data) {
            if (data.status) {
                flashMessage('{{ 'paywall.flash.message.subscription.deleted'|trans }}');
                window.location.reload();
            }
        });
    });
    {% endif %}
</script>
